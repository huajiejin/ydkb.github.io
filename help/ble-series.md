# BLE双模使用

YDKB BLE系列的键盘与市面上的大部分量产的双模或蓝牙键盘，在蓝牙的配对，设备的切换上，都有较明显的区别，不要单凭之前的经验来使用本系列的产品。

这个方案是从2018年1月开始使用的，首款键盘为YD60BLE。

BLE系列泛指YDKB支持的，集成nrf51蓝牙模块的键盘，列表如下。

> [!yddl] High-end
> - 1800mini
> - Mater98
> - X-8086K
> - Sairo64

> [!yddl] BLE
> - BLE40
> - BLUP
> - CAD66
> - Chicory
> - Duang60
> - Duang60 v2
> - Chicory
> - Fmini
> - Just60
> - Just66
> - Just660
> - Just68
> - Just68v2
> - Louise
> - Minira
> - Minira v2
> - Pearly
> - Xikii i6x/i8x/i104
> - YD60BLE
> - YD67BLE
> - YDP50
> - YDPM40BLE

> [!yddl] YDKB Mod
> - BLE660C
> - BLE980C
> - BLE980M
> - HHKB_BLE

蓝牙固件使用的是Adafruit的，参考资料：<br>
https://learn.adafruit.com/introducing-the-adafruit-bluefruit-le-uart-friend/introduction

下文中所有提到按 <kbd>LShift+RShift+某个按键</kbd> 或 <kbd>LShift+RShift+LCtrl+某个按键</kbd> ，都是指先按住 左Shift和右Shift(可能还有左Ctrl) 不放，再按一下 这个按键，之后就可以松开 左Shift和右Shift(可能还有左Ctrl) 了。这些命令按键不能连接按，每次只能按一个命令，要按另外一个，就需要放开左右Shift，再重新按下左右Shift加其他按键。

> [!ydda] 重要建议：
>  - 即使键盘不喜欢或不需要灯的，至少请把Caps指示灯装上。
>  - 在没有自带灯的键盘上，Caps指示灯还会用于指示蓝牙的各种状态、电池低电量、刷机状态等等。

## 蓝牙配对
首先保持键盘通电正常，比如插着USB线，或者没插线但电池开关是打开的。同时这里也说明一点，BLE系列的键盘上的实体开关，均为电池供电开关，而非蓝牙开关。

台式机用户，如果是内置的蓝牙模块，那么请把天线安装上，这种模块wifi与蓝牙都是需要那个天线的。

BLE系列的键盘蓝牙配对与量产的蓝牙键盘有所不同，不需要按特定的按键让键盘进入配对模式，保持下面几点就能让设备搜索到蓝牙。
  1. 键盘蓝牙功能并未关闭。
  2. 键盘蓝牙未连接任何的设备。
  3. 键盘蓝牙处于可搜索状态。

默认情况这三个都是不用额外设置的，如果还是搜不到。其中1和2可以通过 [蓝牙开关和连接状态](/ble-series/connection-status) 来检查。如果1和2无问题，3可以用快捷键开启(LShift+RShift+I)。

在满足上面三个条件时，然后设备又是硬件支持蓝牙4.0的，那么应该能直接搜索到，点击即可连接。

各个不同系统的配对，具体参考对应的说明。
  - Windows 7因为系统不支持蓝牙4.0，所以是需要额外驱动的
  - Linux有些系统带的蓝牙4.0驱动也不一定工作完美

如果出现<html><font color="blue">配对或连接异常，包括但不限于无法配对，配对后重新开关电源会连接不上,电脑反复显示已连接已配对等</font></html>，可使用键盘的<html><font color="red">清除已配对（<kbd>LShift+RShift+R</kbd> 或 <kbd>LShift+RShift+LCtrl+R</kbd> 或自行设置）</font></html>功能，这个操作是清除蓝牙模块内的所有已配对信息，必须执行它之后再在设备上重新配对，而不是仅在设备上删除蓝牙键盘再配对，那样不一定能解决问题。


## 多设备切换

蓝牙与USB切换，可以自己设置一个按键，或者使用 <kbd>LShift+RShift+U</kbd>。

受Adafruit的蓝牙固件限制，可以配对了多个蓝牙设备，但是不支持在不同蓝牙设备之间的主动切换。如果配对了A B两个设备，他们蓝牙连接的时候如果两者都打开了，可能就随机连上A或B。借由这个特点也实现了类似的切换效果，具体见： [多设备切换](/ble-series/device-switching)。


## 指示灯说明

在蓝牙模式下，Num Lock, Caps Lock, Scroll Lock 这些指示灯，无法同步显示电脑的这三者状态。只是按一下按键就切换显示一次对应指示灯。在USB模式下是同步显示的。

如果不同步了，可以使用 Shift+对应按键，比如 Shift+Capslock，这时CapsLock会生效但是对应指示灯的状态不会变。合理利用这一点也可以在蓝牙下反转指示灯使用，比如numlock指示灯在亮的时候是关，灭的时候是开，可以省电。


## 充电注意
建议使用电脑的usb口或者正规的5v充电器来充电，输入电压太高，哪怕只是瞬时太高，都可能损坏充电IC。

如果出现充电不当导致蓝牙失效的情况，后果自付。

且使用大功率充电器不会提高充电速度，大部分BLE系列默认充电电流约450ma，具体可以见各键盘的说明。


## 节能说明

简单的说一下我对BLE系列的节能设置，方便各位更好的使用它们。

节能模式默认是开启的且只在使用电池时节能，可以通过左右Shift+P切换开关，关掉节能模式后，键盘完全不会进入节能，适合一直开着灯光展示用。这个设置是不保存的，一旦键盘重启，比如重新开关，就会恢复到默认开启状态。

节能模式
  1. 正常使用时，如果15秒没有按键盘，背光则会关闭，键盘进入一级节能，这时候随便按键，背光就会亮起，键盘也会立即响应。
  2. 在1的基础上，如果继续一直未按键超过2.5小时，键盘进入二级节能。
  3. 如果蓝牙断开后处于未连接状态超过90秒，键盘会进入二级节能。
  4. 如果按键Lock Mode，一旦进入Lock Mode后，键盘也会进入二级节能。

二级节能模式下，硬件上蓝牙模块电源关闭，在2和3这种情况下，按任意键可以唤醒键盘，如果有开灯光，灯光会亮起，这时蓝牙需要重新连接，所以需要等1到3秒系统才会响应键盘，这是与1的一级节能不同的。在4的这种情况，只能使用F和J同时按来唤醒，这在Lock Mode里面有介绍。


## 背景故事
这一些还是在1800mini的时候写下的，也是BLE系列开始时的想法，记录下来，有兴趣的可以看看。

现今的不少双模或蓝牙机械键盘不够好用，我简单总结一下主要是几个原因。
  1. 蓝牙连接不稳定。
  2. 键盘从节能到唤醒速度太慢。甚至不少键盘在键盘节能后，按的第一个键可能还根本不会输出。
  3. 续航能力太弱。
  4. 不支持按键编程。

所以主要也是针对这几点去改善，第一点不稳定有很多其实是固件与模块本身的原因，但是量产的键盘，其中很多都是买的成品方案，也不能指望再改进什么了。所以，
  1. 针对1，使用蓝牙模块为进口优质产品，并且蓝牙固件也不是我这种半调子水平写出来的，同时使用蓝牙模块也不用自己再去考虑天线的问题。而事实证明这款模块的天线设计效果非常的OK。
  2. 针对2，不考虑那么极致的省电，就BLE40使用1500mah的电池来看，不开灯的情况下，每天使用15小时+，使用1到2个月没问题。虽然达不到有些键盘电池用半年那种续航，但是也够满足了。同时还提供了临时关闭节能的功能，这样可以让键盘处于荧光棒模式（键盘灯一直亮）。
  3. 针对3，这里有从硬件上的优化，硬件上尽量的去减少耗电，即使都是BLE的蓝牙模块，在做为HID工作时，它们的耗电都可以差到10倍以上。目前这个模块在蓝牙工作时，它本身耗电只有1.xma。可能还有不少人记得BLE60，那个使用的CSR1010的模块，实测其本身工作时耗电在10ma以上。然后就是配合合适的节能设置了，平衡使用体验与续航。
  4. 针对4，BLE系列支持全键编程，共8层可以设置。
