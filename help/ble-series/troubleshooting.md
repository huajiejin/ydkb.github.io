# BLE系列排错指南

本部分旨在帮助用户查找并解决问题。指南依然还在不断完善中。

> [!yddh: 提醒]
> - 遇错时，先操作一下重新断电(关闭开关或拔电池)，再通电，是否恢复正常。
> - 请逐步根据步骤操作，以查找问题。有时蓝牙配对或连接问题，并不一定出在键盘端，也可能是设备（电脑）端系统或驱动原因。

> [!ydda: 特别注意]
> - 排错首先建议在键盘还能运行，比如指示灯或连接USB时至少还能部分工作的。
> - 在满足上一条的基础上，可以借助键盘指示灯查看当前的工作状态。
> - 当方便连接USB使用时，更建议使用文字输出电量的数值来进行排错。

下文中所有提到按<kbd>LShift+RShift</kbd>+<kbd>某个按键</kbd>或<kbd>LShift+RShift+LCtrl</kbd>+<kbd>某个按键</kbd>，都是指先按住 左Shift和右Shift(可能还有左Ctrl) 不放，再按一下 这个按键，之后就可以松开 左Shift和右Shift(可能还有左Ctrl) 了。这些命令按键不能连接按，每次只能按一个命令，要按另外一个，就需要放开左右Shift，再重新按下左右Shift加其他按键。

下文中提到的<kbd>LShift+RShift+LCtrl+R</kbd>，按后会有连接指示灯提示。如果按了后没提示，则可能固件是早于DKAD(2020-10-13) 的，那么建议先更新固件，如果不更新固件则使用<kbd>LShift+RShift+R</kbd>(按后无连接指示灯)。

## 快速排错法以及定心丸

1. 首先确认有线连接时键盘能打出字。这种情况下键盘80%可能无问题了。
2. 有线能打字时，<kbd>LShift+RShift+V</kbd>打出的文字输出电量是正常的，即非12或44或45。那么键盘硬件90%可能无问题了。清除一次键盘端配对信息再重新配对，一般可解决问题。
3. 如果一直没解决问题，那使用 [重置蓝牙](reset-ble.md)后成功后，即蓝牙名称能恢复到默认的Adafruit Bluefruit LE，然后再重新初始化为键盘名。那么99%键盘蓝牙硬件这边无问题。如果成功重置蓝牙后问题依旧，则把排错的着手方向转向电脑端试试(比如系统bug或驱动问题)。

## 蓝牙反复 已连接/已配对

如果是这种情况，原因是键盘端与电脑端的配对信息不匹配，按下面方法重新配对一次。
  1. 先删除电脑上已经配对的该蓝牙键盘。
  2. 清除键盘端保存的配对信息。方法是在键盘上按<kbd>LShift+RShift+LCtrl+R</kbd>，按后会有连接指示灯提示。
  3. 设备搜索键盘，重新配对一次。

> [!yddh: 提醒]
> - 请注意平时使用不要误按清除键盘端配置信息这组快捷键，误按后键盘与电脑配对信息不匹配，就会造成此问题。在DKAD(2020-10-13)之后的固件改为使用<kbd>LShift</kbd>+<kbd>RShift</kbd>+<kbd>LCtrl</kbd>+<kbd>R</kbd>一部分原因就是为了防止误按。

## 无法搜索到蓝牙

使用指示灯确认状态时，请依照 [蓝牙开关和连接状态](ble-series/connection-status) 内的具体说明。

以下内容，当有条件使用USB连接时，建议优先选择USB连接下文字输出电量进行排错。

### 1 确认当前并没有关闭蓝牙功能（不是指电池开关）。

```ad-yddcol0
##### 使用文字输出电量的方法(建议此法)
1. 在能打字的地方，按默认快捷键<kbd>LShift+RShift+V</kbd>或自定义的按键，输出电量文字信息。
2. 如果数字是12，则说明蓝牙功能关闭了。非12则蓝牙功能为开启状态。
```

```ad-yddcol1
##### 使用连接状态指示灯
1. 当重新插入USB线或者是按下 <kbd>LShift+RShift+S</kbd> 时，连接状态的指示灯是亮的。
2. 如果这些操作，连接状态指示灯都不亮，那么蓝牙功能可能是关闭的（或者灯坏了）。

```

##### 假如从上面得到结果是蓝牙功能为关闭
一些键盘请使用 <kbd>LShift+RShift+W</kbd> 先开启蓝牙功能；一些键盘上的开关是同时作为电源开关和蓝牙开关的，就请打开开关以开启蓝牙功能（2023年之后的固件的，如果输出的电量数字是120，就是后者）。

再重新测试步骤1，确保蓝牙是开启的，即文字输出的电量不再是12。这时，可能能搜索或连接蓝牙了。

如果此时问题依然没解决，那么再继续往下看。

### 2 确认当前蓝牙的通信状态和连接状态

```ad-yddcol0
##### 使用文字输出电量的方法(建议此法)
1. 用<kbd>LShift+RShift+V</kbd>打出的电量信息是XX-Y格式的。前面的XX代表电量，后面的Y代表连接状态。
2. 如果XX不是44或45，当然也不能是12。那么Y为1的时候，说明键盘本身是已连接状态，可能连接到了其他某个设备。
3. 如果XX是44或45，则是获取信息失败，这可能是通信不成功或者电量服务出错的原因，这种情况需要重置蓝牙。
```

```ad-yddcol1
##### 使用连接状态指示灯
1. 当重新插入USB线或者是按下 <kbd>LShift+RShift+S</kbd> 时，连接状态的指示灯必须是亮的。
2. 如果当前指示是已连接。检查是不是已经连上了你现在的某个设备，或者其他人的某个设备。
3. 如果两者都不是，即闪的频率其实并不固定，每几次可能快一下或慢一下，那说明并未获取到正确的蓝牙连接状态，这时可能需要重置蓝牙。
```

##### 从上面的测试可以得到两个可能：
  - 如果是需要重置蓝牙，这个请参看 [重置蓝牙](ble-series/reset-ble)
  - 如果是确认当前指示蓝牙未连接且通讯状态正常，那么尝试按一下键盘的<kbd>LShift+RShift+LCtrl+R</kbd>，按后会有连接指示灯提示。再搜索应该能搜到了。


## 蓝牙已连接但无法使用

此问题具体描述为：蓝牙能自动连接，并且电脑上状态也显示一直是已连接，但是按键无法使用。

如果是Windows系统，请参考[windows 配对](../en/ble-series/windows-pairing.md)，在首次配对等一些情况下，需要配对后，删除一次，再重新配对，才能连接和使用正常。

其他的系统以及其他的情况下遇到此问题，继续往下看。

### 1 确认键盘固件正常

关闭电池开关，蓝牙断开，然后重新打开开关，确认是否蓝牙还是会变为已连接。这时依然无法使用，则试一下USB连接是否可用，USB可以正常使用时固件应该还是正常的。

### 2 确认蓝牙通讯状态正常

使用文字输出电量功能，结果不是44或45。如果是，则需要重置蓝牙，参看这里 [重置蓝牙](ble-series/reset-ble)

### 3 清除键盘端配对信息，重新配对

文字输出电量正常时，先假设问题是在键盘端，按下面方法重新配对一次。
  1. 先删除电脑上已经配对的该蓝牙键盘。
  2. 清除键盘端保存的配对信息。方法是在键盘上按<kbd>LShift+RShift+LCtrl+R</kbd>，按后会有连接指示灯提示。
  3. 设备搜索键盘，重新配对一次。

> [!yddh: 提醒]
> - 这部分操作重点是第2步的“清除键盘内保存的配对信息”。如果不操作第2步，那么删除后重新配对虽然能用，但是下次连接又可能只是显示已连接但无法使用。

### 4 键盘连接到其他设备对比

如果以上操作后依然不行，也有可能是电脑驱动或系统bug，可以尝试一下把键盘配对到其他设备，比如手机或其他电脑，以作对比。

### 5 一种特殊情况：二级节能(含Lock Mode)唤醒后遇此问题

具体表现为从二级节能(包含Lock Mode)唤醒后，电脑上显示为已连接，但是键盘不可用。而这时如果用 <kbd>LShift+RShift+B</kbd>重启一次键盘，这次电脑显示已连接后，键盘大概率是可以使用的。

可以通过Lock Mode快速复现这个问题。这种情况是硬件问题引起的，具体可能是MCU（32u4）旁边的C1或C2电容出问题了，那两个为1uF电容。有能力的，如果明显的外观损伤或者测量的出它的值就不对，就换一个。如果能看到虚焊了，就补焊一下。如果自己搞不了，就找卖家返修一下。


## 蓝牙无法自动连接

此问题具体描述为：电脑重启或键盘重新开关后，蓝牙未能自动连接，但如果此时将电脑上配对的键盘删除，然后重新搜索键盘能搜到，并且重新配对后可以使用。

### 1 确认键盘自身的蓝牙连接状态

```ad-yddcol0
##### 使用文字输出电量的方法(建议此法)
1. 用<kbd>LShift+RShift+V</kbd>打出的电量信息是XX-Y格式的。前面的XX代表电量，后面的Y代表连接状态。
2. Y为1的时候，说明键盘本身是已连接状态，可能连接到了其他某个设备。
```

```ad-yddcol1
##### 使用连接状态指示灯
1. 按下 <kbd>LShift+RShift+S</kbd>，查看连接状态的指示灯。
2. 如果当前指示是已连接。检查是不是已经连上了你现在的某个设备，或者其他人的某个设备。
```

如果确认键盘自身报告的是未连接状态，继续往下看。

### 2 清除键盘端配对信息，重新配对

如果是这种情况，按下面方法重新配对一次。
  1. 先删除电脑上已经配对的该蓝牙键盘。
  2. 清除键盘端保存的配对信息。方法是在键盘上按<kbd>LShift+RShift+LCtrl+R</kbd>，按后会有连接指示灯提示。
  3. 设备搜索键盘，重新配对一次。

> [!yddh: 提醒]
> - 这部分操作重点是第2步的“清除键盘内保存的配对信息”。如果不操作第2步，那么删除后重新配对虽然能用，但是下次连接又可能只是显示已连接但无法使用。

以上重新配对后，键盘在蓝牙状态下可以使用了。

### 3 重新确认自动连接是否正常
尝试关闭再重新开启电脑的蓝牙，或者关闭再重新开启键盘的电池开关，总之让蓝牙断开一下，然后看它是否自动重新连接。并且键盘正常使用。

### 4 键盘连接到其他设备对比

如果以上操作后依然不行，也有可能是电脑驱动或系统bug，可以尝试一下比如把键盘配对到手机，然后手机蓝牙关闭再重新打开，看手机这边是否可以自动连接。

### 5 重置蓝牙

在测试第4点后发现是键盘连接到所有设备，然后断开重连都无法自动连接。

那么尝试 [重置蓝牙](ble-series/reset-ble)，这个相比于清除配对信息，整个蓝牙的配置都会重新初始化。蓝牙能够正确的重置并且能重新初始化，一般可以认为蓝牙硬件一切正常。


## 蓝牙能搜到但是无法连接

这个有一些win10的用户出现过。表现的情况如下，能搜索到蓝牙，但是怎么都无法连接成功。

![](assets/ble_troubleshooting_40.png)

### 1 如果是第一次键盘时就遇到了此问题

首先确认一下电脑的蓝牙天线安装了。台式机有的主板有自带wifi与蓝牙的模块，或者说可以自己安装的。即使不使用wifi，只使用蓝牙，也必须将它的外置天线装上。如果不装，蓝牙信号也是极差极差约等于不能用的。信号不足的时候也会出现偶尔能搜索到但是连接总不成功。

### 2 之前有在此电脑上正常使用此键盘，再遇到的此问题

这个可能是win10系统的蓝牙驱动问题。比如将键盘此时配对到手机，或者其他的win10设备，正常的话，那么90%可能是系统问题了。

先当它不是系统问题吧，在配对前，在键盘上按一次<kbd>LShift+RShift+LCtrl+R</kbd>。早于DKAD(2020-10-13)的固件用<kbd>LShift+RShift+R</kbd>。清除一下键盘端的配对信息，然后连接一下，如果问题依旧，并且也用键盘连接过手机或其他win10电脑确认正常，那么尝试下面的方法。

### 3 如果是系统的问题

先是简单一点，重新关闭电脑的蓝牙，再打开，然后再搜索并连接，看是否可行。

如果不行尝试一下重启电脑，俗话说得好，重启能解决90%的问题。

如果依然不行，就尝试下面的操作，有遇到类似问题的用户用下面方式有解决。

##### 卸载并重新安装蓝牙驱动
1. 在设备管理器里，右键点击蓝牙的硬件，选择卸载，同时注意**勾上删除此设备的驱动程序软件**。

![](assets/ble_troubleshooting_41.png)

2. 在设备管理器里点鼠标右键，然后选择 **扫描检测硬件改动**。这里系统会自动重新发现蓝牙并安装驱动，一般自动更新的驱动，使用无问题。
